<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Master V7.6 (Clean & Restore)</title>
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0f766e', 
                        primaryDark: '#115e59', 
                        bgSoft: '#f8fafc',
                        success: '#10b981',
                        successBg: '#ecfdf5',
                        danger: '#f43f5e',
                        dangerBg: '#fff1f2',
                        darkCard: '#1e293b',
                    },
                    animation: { slideUp: 'slideUp 0.3s ease-out' },
                    keyframes: { slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        input, button { outline: none; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;
        const DATA_KEY = 'finance_master_final_v76'; // Final Stable Key

        // --- ICONS ---
        const Icon = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>;
        const Icons = {
            PieChart: () => <Icon d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" className="w-5 h-5" />,
            Wallet: () => <Icon d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z" className="w-5 h-5" />,
            Exchange: () => <Icon d="M20.66 12L18.06 14.6a2.828 2.828 0 0 1-4 0l-3.34-3.34a2.828 2.828 0 0 0-4 0L4.06 13.94a2.828 2.828 0 1 0 4 4l2.66-2.66 2.6 2.6a2.828 2.828 0 1 0 4-4l-3.34-3.34a2.828 2.828 0 0 1 4 0l2.68 2.68" className="w-6 h-6" />,
            Briefcase: () => <Icon d="M20 7h-4V4c0-1.1-.9-2-2-2h-4C9 2 8 2.9 8 4v3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2z" className="w-5 h-5" />,
            Plus: () => <Icon d="M12 5v14M5 12h14" className="w-6 h-6" />,
            Trash: () => <Icon d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" className="w-4 h-4" />,
            Pencil: () => <Icon d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" className="w-4 h-4" />,
            Calendar: () => <Icon d="M19 4h-1V3a1 1 0 0 0-2 0v1H8V3a1 1 0 0 0-2 0v1H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2 2V6a2 2 0 0 0-2-2zm0 16H5V9h14v11z" className="w-5 h-5" />,
            Check: () => <Icon d="M20 6L9 17l-5-5" className="w-5 h-5" />,
            X: () => <Icon d="M18 6L6 18M6 6l12 12" className="w-6 h-6" />,
            Left: () => <Icon d="M15 18l-6-6 6-6" className="w-5 h-5" />,
            Right: () => <Icon d="M9 18l6-6-6-6" className="w-5 h-5" />,
            Lock: () => <Icon d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" className="w-5 h-5" />,
            Moon: () => <Icon d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" className="w-5 h-5" />,
            Sun: () => <Icon d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z" className="w-5 h-5" />,
            Settings: () => <Icon d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" className="w-5 h-5" />,
            Download: () => <Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" className="w-5 h-5" />,
            Refresh: () => <Icon d="M23 4v6h-6M1 20v-6h6" className="w-5 h-5" />,
        };

        const safeNum = (val) => { const num = parseFloat(val); return isFinite(num) ? num : 0; };
        const calculateSafe = (val) => { try { return String(val||'').replace(/[^0-9.+\-]/g, '').split('+').reduce((sum, part) => sum + (parseFloat(part)||0), 0); } catch { return 0; } };

        const loadData = () => {
            try {
                const raw = localStorage.getItem(DATA_KEY);
                if (!raw) return { cashflow: [], debts: [], assets: [], settings: { budget: 0, darkMode: false, pin: null } };
                const parsed = JSON.parse(raw);
                return {
                    cashflow: Array.isArray(parsed.cashflow) ? parsed.cashflow : [],
                    debts: Array.isArray(parsed.debts) ? parsed.debts : [],
                    assets: Array.isArray(parsed.assets) ? parsed.assets : [],
                    settings: parsed.settings || { budget: 0, darkMode: false, pin: null }
                };
            } catch { return { cashflow: [], debts: [], assets: [], settings: { budget: 0, darkMode: false, pin: null } }; }
        };

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() { if (this.state.hasError) return <div className="h-screen flex items-center justify-center"><button onClick={() => window.location.reload()} className="bg-primary text-white p-4 rounded">Reset App</button></div>; return this.props.children; }
        }

        function App() {
            const [data, setData] = useState(loadData);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isLocked, setIsLocked] = useState(!!(data.settings && data.settings.pin));
            const [showSettings, setShowSettings] = useState(false);
            const [darkMode, setDarkMode] = useState(data.settings ? data.settings.darkMode : false);

            useEffect(() => {
                const newData = { ...data, settings: { ...data.settings, darkMode } };
                localStorage.setItem(DATA_KEY, JSON.stringify(newData));
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [data, darkMode]);

            const addEntry = (key, item) => {
                const finalAmt = calculateSafe(item.amount);
                const newItem = key === 'debts' ? { ...item, amount: finalAmt, paid: 0, status: 'active' } : { ...item, amount: finalAmt };
                setData(prev => ({ ...prev, [key]: [{ ...newItem, id: Date.now(), date: new Date().toISOString() }, ...(prev[key]||[])] }));
            };
            const updateEntry = (key, id, updates) => {
                setData(prev => ({
                    ...prev,
                    [key]: prev[key].map(item => {
                        if (item.id !== id) return item;
                        const updatedItem = { ...item, ...updates };
                        if(key === 'debts') {
                            if(updates.amount !== undefined) updatedItem.amount = calculateSafe(updates.amount);
                            if(updates.paid !== undefined) updatedItem.paid = safeNum(updates.paid);
                            updatedItem.status = updatedItem.paid >= updatedItem.amount ? 'completed' : 'active';
                        } else {
                            if(updates.amount !== undefined) updatedItem.amount = calculateSafe(updates.amount);
                        }
                        return updatedItem;
                    })
                }));
            };
            const deleteEntry = (key, id) => { if(confirm("Delete?")) setData(prev => ({ ...prev, [key]: prev[key].filter(i => i.id !== id) })); };
            const updateSettings = (newSettings) => setData(prev => ({ ...prev, settings: { ...prev.settings, ...newSettings } }));
            
            const handleSetPin = (pin) => {
                setData(prev => ({ ...prev, settings: { ...prev.settings, pin: pin } }));
                setShowSettings(false);
                alert(pin ? "PIN Set!" : "PIN Removed!");
            };

            // Restore Data Logic
            const handleRestore = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const content = JSON.parse(ev.target.result);
                        if(content.cashflow) {
                            if(confirm("Restore data from backup? This will replace current data.")) {
                                setData(content);
                                alert("âœ… Data Restored Successfully!");
                            }
                        } else { alert("Invalid Backup File"); }
                    } catch { alert("Error parsing file"); }
                };
                reader.readAsText(file);
            };

            if (isLocked && data.settings?.pin) return <PinScreen correctPin={data.settings.pin} onUnlock={() => setIsLocked(false)} />;

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative bg-bgSoft text-slate-800 dark:bg-gray-900 dark:text-white transition-colors duration-300">
                    <div className="flex justify-between items-center p-5 bg-white dark:bg-darkCard sticky top-0 z-40 shadow-sm">
                        <h1 className="text-xl font-black text-primary tracking-tight dark:text-white">Finance Master</h1>
                        <div className="flex gap-2">
                            <button onClick={() => setShowSettings(true)} className="p-2 rounded-full bg-gray-100 dark:bg-slate-700 text-slate-600 dark:text-white transition-colors"><Icons.Settings /></button>
                        </div>
                    </div>

                    <div className="p-4">
                        {activeTab === 'dashboard' && <DashboardTab data={data} onRestore={handleRestore} />}
                        {activeTab === 'cashflow' && <CashflowTab data={data.cashflow} onAdd={(i)=>addEntry('cashflow',i)} onUpdate={(id, d)=>updateEntry('cashflow', id, d)} onDelete={(id)=>deleteEntry('cashflow',id)} />}
                        {activeTab === 'debts' && <DebtsTab data={data.debts} onAdd={(i)=>addEntry('debts',i)} onUpdate={(id, d)=>updateEntry('debts', id, d)} onDelete={(id)=>deleteEntry('debts',id)} />}
                        {activeTab === 'assets' && <AssetsTab data={data.assets} onAdd={(i)=>addEntry('assets',i)} onDelete={(id)=>deleteEntry('assets',id)} />}
                    </div>

                    <div className="fixed bottom-0 w-full max-w-md bg-white dark:bg-darkCard border-t border-slate-100 dark:border-slate-800 flex justify-around py-3 pb-safe z-30">
                        <NavBtn id="dashboard" icon={<Icons.PieChart />} label="Overview" active={activeTab} set={setActiveTab} />
                        <NavBtn id="cashflow" icon={<Icons.Wallet />} label="CashFlow" active={activeTab} set={setActiveTab} />
                        <NavBtn id="debts" icon={<Icons.Exchange />} label="Debts" active={activeTab} set={setActiveTab} />
                        <NavBtn id="assets" icon={<Icons.Briefcase />} label="Assets" active={activeTab} set={setActiveTab} />
                    </div>

                    {showSettings && <SettingsModal currentPin={data.settings?.pin} darkMode={darkMode} onSave={(s) => { updateSettings(s); setDarkMode(s.darkMode); }} onClose={() => setShowSettings(false)} />}
                </div>
            );
        }

        const NavBtn = ({ id, icon, label, active, set }) => (
            <button onClick={() => set(id)} className={`flex flex-col items-center gap-1 w-16 transition-all duration-300 ${active === id ? 'text-primary scale-110' : 'text-slate-400 dark:text-slate-500'}`}>
                <div>{icon}</div>
                <span className="text-[10px] font-bold">{label}</span>
            </button>
        );

        function PinScreen({ correctPin, onUnlock }) {
            const [input, setInput] = useState('');
            const handleNum = (n) => { const next = input + n; setInput(next); if (next.length === 4) { if (next === correctPin) onUnlock(); else { alert("Wrong PIN"); setInput(''); } } };
            return (
                <div className="h-screen bg-primary dark:bg-darkCard flex flex-col items-center justify-center text-white">
                    <div className="mb-6 p-4 bg-white/10 rounded-full"><Icons.Lock className="w-8 h-8" /></div>
                    <h2 className="text-xl font-bold mb-8">Enter PIN</h2>
                    <div className="flex gap-4 mb-10">{[0,1,2,3].map(i => (<div key={i} className={`w-4 h-4 rounded-full border-2 border-white/50 ${input.length > i ? 'bg-white' : ''}`}></div>))}</div>
                    <div className="grid grid-cols-3 gap-6 w-64">
                        {[1,2,3,4,5,6,7,8,9].map(n => (<button key={n} onClick={() => handleNum(n)} className="w-16 h-16 rounded-full bg-white/10 text-2xl font-bold active:bg-white/30 transition-colors">{n}</button>))}
                        <div className="col-start-2"><button onClick={() => handleNum(0)} className="w-16 h-16 rounded-full bg-white/10 text-2xl font-bold active:bg-white/30 transition-colors">0</button></div>
                    </div>
                </div>
            );
        }

        function SettingsModal({ currentPin, darkMode, onSave, onClose }) {
            const [isPinEnabled, setIsPinEnabled] = useState(!!currentPin);
            const [pin, setPin] = useState(currentPin || '');
            const [isDark, setIsDark] = useState(darkMode);

            const handleSave = () => {
                if (isPinEnabled && pin.length !== 4) return alert("PIN must be 4 digits");
                onSave({ pin: isPinEnabled ? pin : null, darkMode: isDark });
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                    <div className="bg-white dark:bg-darkCard w-[90%] max-w-sm p-6 rounded-2xl shadow-2xl animate-slideUp">
                        <h3 className="text-lg font-bold text-slate-800 dark:text-white mb-6">App Settings</h3>
                        <div className="flex justify-between items-center mb-6 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
                            <div className="flex items-center gap-3"><div className="text-slate-500 dark:text-white"><Icons.Moon /></div><span className="font-bold text-slate-700 dark:text-white">Dark Mode</span></div>
                            <button onClick={() => setIsDark(!isDark)} className={`w-12 h-6 rounded-full p-1 transition-colors ${isDark ? 'bg-primary' : 'bg-slate-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${isDark ? 'translate-x-6' : ''}`}></div></button>
                        </div>
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-2"><Icons.Lock className="text-slate-500 dark:text-white w-5 h-5" /><span className="font-bold text-slate-700 dark:text-white">App Lock (Optional)</span></div>
                            <button onClick={() => setIsPinEnabled(!isPinEnabled)} className={`w-12 h-6 rounded-full p-1 transition-colors ${isPinEnabled ? 'bg-primary' : 'bg-slate-300'}`}><div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${isPinEnabled ? 'translate-x-6' : ''}`}></div></button>
                        </div>
                        {isPinEnabled && (
                            <div className="mb-6 animate-fadeIn">
                                <label className="text-xs text-slate-400 uppercase font-bold mb-1 block">Set 4-Digit PIN</label>
                                <input type="number" className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl text-center text-xl tracking-widest font-bold border border-slate-200 dark:border-slate-700" value={pin} onChange={e => setPin(e.target.value.slice(0,4))} placeholder="0000" />
                            </div>
                        )}
                        <div className="flex gap-3 mt-4">
                            <button onClick={onClose} className="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-white font-bold">Cancel</button>
                            <button onClick={handleSave} className="flex-1 py-3 rounded-xl bg-primary text-white font-bold">Save Settings</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- DASHBOARD ---
        function DashboardTab({ data, onRestore }) {
            const cashOnHand = (data.cashflow || []).filter(i=>i.type==='income').reduce((s,i)=>s+safeNum(i.amount),0) - (data.cashflow || []).filter(i=>i.type==='expense').reduce((s,i)=>s+safeNum(i.amount),0);
            const assetsUsd = (data.assets || []).filter(i=>i.currency==='$').reduce((s,i)=>s+safeNum(i.amount),0);
            const assetsKs = (data.assets || []).filter(i=>i.currency==='Ks').reduce((s,i)=>s+safeNum(i.amount),0);
            const debtsUsd = (data.debts || []).filter(d=>d.currency==='$').reduce((s,d)=> s + (d.type==='lent' ? (d.amount-d.paid) : -(d.amount-d.paid)), 0);
            const debtsKs = (data.debts || []).filter(d=>d.currency==='Ks').reduce((s,d)=> s + (d.type==='lent' ? (d.amount-d.paid) : -(d.amount-d.paid)), 0);

            const handleBackup = () => {
                const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            };

            return (
                <div className="space-y-6 animate-slideUp pb-10">
                    <div className="bg-gradient-to-br from-primary to-primaryDark text-white p-6 rounded-[2rem] shadow-2xl shadow-primary/30 relative overflow-hidden">
                        <h2 className="text-primaryLight text-xs font-bold tracking-widest uppercase mb-3">Net Worth Breakdown</h2>
                        <div className="grid grid-cols-2 gap-4">
                            <div><p className="text-[10px] text-primaryLight uppercase">USD ($)</p><div className="text-2xl font-black tracking-tight">${(cashOnHand + assetsUsd + debtsUsd).toLocaleString()}</div></div>
                            <div className="text-right border-l border-white/20 pl-4"><p className="text-[10px] text-primaryLight uppercase">MMK (Ks)</p><div className="text-2xl font-black tracking-tight">{(assetsKs + debtsKs).toLocaleString()}</div></div>
                        </div>
                        <div className="mt-4 pt-4 border-t border-white/10 flex justify-between items-center">
                            <span className="text-xs font-medium text-primaryLight">Liquid Cash</span>
                            <span className="text-lg font-bold">${cashOnHand.toLocaleString()}</span>
                        </div>
                    </div>

                    <div className="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700 grid grid-cols-2 gap-3">
                        <button onClick={handleBackup} className="bg-white dark:bg-darkCard border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 p-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 shadow-sm active:scale-95 transition-transform"><Icons.Save className="text-primary w-4 h-4" /> Backup</button>
                        <label className="bg-white dark:bg-darkCard border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 p-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 cursor-pointer shadow-sm active:scale-95 transition-transform"><Icons.Refresh className="text-primary w-4 h-4" /> Restore Data<input type="file" accept=".json" onChange={onRestore} className="hidden" /></label>
                    </div>
                </div>
            );
        }

        // --- CASHFLOW TAB ---
        function CashflowTab({ data, onAdd, onUpdate, onDelete }) {
            const [isOpen, setIsOpen] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [filter, setFilter] = useState('all');
            const [currentMonth, setCurrentMonth] = useState(new Date().toISOString().slice(0, 7));

            const monthData = (data || []).filter(item => item.date && item.date.startsWith(currentMonth));
            const filtered = monthData.sort((a,b) => new Date(b.date) - new Date(a.date)).filter(i => filter === 'all' || i.type === filter);
            const grouped = filtered.reduce((groups, item) => {
                const d = new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                if (!groups[d]) groups[d] = []; groups[d].push(item); return groups;
            }, {});

            const changeMonth = (d) => { const date = new Date(currentMonth + '-01'); date.setMonth(date.getMonth() + d); setCurrentMonth(date.toISOString().slice(0, 7)); };
            const formatMonth = (ym) => { const [y, m] = ym.split('-'); return new Date(y, m - 1).toLocaleString('default', { month: 'long', year: 'numeric' }); };

            return (
                <div className="pb-20 space-y-4 animate-slideUp">
                    <div className="flex justify-between items-center bg-white dark:bg-darkCard p-3 rounded-xl shadow-sm mb-2">
                        <button onClick={() => changeMonth(-1)} className="p-2 bg-gray-100 dark:bg-slate-700 rounded-full"><Icons.Left className="w-4 h-4 text-slate-600 dark:text-white"/></button>
                        <div className="font-bold text-slate-700 dark:text-white flex items-center gap-2"><Icons.Calendar className="w-4 h-4 text-primary"/> {formatMonth(currentMonth)}</div>
                        <button onClick={() => changeMonth(1)} className="p-2 bg-gray-100 dark:bg-slate-700 rounded-full"><Icons.Right className="w-4 h-4 text-slate-600 dark:text-white"/></button>
                    </div>

                    <div className="flex bg-gray-200 dark:bg-slate-800 p-1 rounded-xl">
                        {['all', 'income', 'expense'].map(t => (
                            <button key={t} onClick={() => setFilter(t)} className={`flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all ${filter === t ? 'bg-white dark:bg-darkCard shadow text-primary dark:text-white' : 'text-slate-500'}`}>{t}</button>
                        ))}
                    </div>

                    {Object.keys(grouped).length === 0 ? <div className="text-center py-20 text-slate-400 text-sm">No records found</div> : 
                        Object.keys(grouped).map(date => (
                            <div key={date}>
                                <h3 className="text-xs font-bold text-slate-400 mb-2 pl-1">{date}</h3>
                                <div className="bg-white dark:bg-darkCard rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                                    {grouped[date].map((item, idx) => (
                                        <div key={item.id} className={`p-4 flex justify-between items-center ${idx !== grouped[date].length-1 ? 'border-b border-slate-50 dark:border-slate-800' : ''}`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg ${item.type==='income'?'bg-successBg text-success':'bg-dangerBg text-danger'}`}>{item.type==='income'?'ðŸ’°':'ðŸ’¸'}</div>
                                                <div><h4 className="font-bold text-slate-700 dark:text-slate-200 text-sm">{item.title}</h4></div>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className={`font-bold text-sm ${item.type==='income'?'text-success':'text-slate-700 dark:text-slate-300'}`}>{item.type==='income'?'+':'-'}${safeNum(item.amount).toLocaleString()}</span>
                                                <button onClick={() => { setEditItem(item); setIsOpen(true); }} className="p-1 bg-slate-50 dark:bg-slate-700 rounded text-slate-400 hover:text-primary"><Icons.Pencil className="w-3 h-3"/></button>
                                                <button onClick={() => onDelete(item.id)} className="p-1 bg-slate-50 dark:bg-slate-700 rounded text-slate-400 hover:text-danger"><Icons.Trash className="w-3 h-3"/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))
                    }
                    <button onClick={() => { setEditItem(null); setIsOpen(true); }} className="fixed bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-xl flex items-center justify-center hover:scale-105 z-20"><Icons.Plus /></button>
                    
                    {isOpen && <TransactionModal initialData={editItem} onClose={() => setIsOpen(false)} onSave={(data) => { if(editItem) onUpdate(editItem.id, data); else onAdd(data); }} />}
                </div>
            );
        }

        function TransactionModal({ initialData, onClose, onSave }) {
            const [form, setForm] = useState(initialData || { type: 'expense', title: '', amount: '' });
            const [isMath, setIsMath] = useState(false);

            const handleSave = () => {
                if (!form.title || !form.amount) return;
                onSave(form);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-start justify-center pt-16">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white dark:bg-darkCard w-[90%] max-w-md rounded-2xl p-6 shadow-2xl z-10 relative animate-slideUp">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">{initialData ? 'Edit Transaction' : 'Add Transaction'}</h3>
                            <button onClick={onClose} className="p-1 bg-slate-100 dark:bg-slate-700 rounded-full"><Icons.X /></button>
                        </div>
                        <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl mb-6">
                            <button onClick={() => setForm({...form, type:'expense'})} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${form.type === 'expense' ? 'bg-white dark:bg-darkCard shadow text-slate-800 dark:text-white' : 'text-slate-400'}`}>Expense</button>
                            <button onClick={() => setForm({...form, type:'income'})} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${form.type === 'income' ? 'bg-white dark:bg-darkCard shadow text-success' : 'text-slate-400'}`}>Income</button>
                        </div>
                        <div className="space-y-4 mb-6">
                            <input autoFocus placeholder="Title (e.g. Food)" className="w-full p-4 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl text-sm font-bold border-2 border-transparent focus:border-primary outline-none" value={form.title} onChange={e => setForm({...form, title:e.target.value})} />
                            <div>
                                <input type="text" placeholder="Amount (e.g. 100+50)" className="w-full p-4 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl text-lg font-bold border-2 border-transparent focus:border-primary outline-none" value={form.amount} onChange={e => { setForm({...form, amount:e.target.value}); setIsMath(e.target.value.includes('+')); }} />
                                {isMath && <p className="text-xs text-primary mt-1 font-medium">Auto-sum: {calculateSafe(form.amount)}</p>}
                            </div>
                        </div>
                        <button onClick={handleSave} className="w-full bg-primary text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95">Save Record</button>
                    </div>
                </div>
            );
        }

        // --- DEBTS TAB (CLEAN) ---
        function DebtsTab({ data, onAdd, onUpdate, onDelete }) {
            const [view, setView] = useState('lent');
            const [showAddModal, setShowAddModal] = useState(false);
            const [repayItem, setRepayItem] = useState(null);
            const [repayAmount, setRepayAmount] = useState('');
            const filtered = data.filter(i => i.type === view);
            const [form, setForm] = useState({ name: '', amount: '', currency: 'Ks', note: '' });

            const handleRepayment = () => {
                if(!repayAmount) return;
                const amountToAdd = parseFloat(calculateSafe(repayAmount));
                const currentPaid = parseFloat(repayItem.paid || 0);
                const newPaid = currentPaid + amountToAdd;
                onUpdate(repayItem.id, { paid: newPaid });
                setRepayItem(null); 
                setRepayAmount('');
            };

            const openAdd = () => { setForm({ id: null, name: '', amount: '', currency: 'Ks', note: '' }); setShowAddModal(true); };
            const openEdit = (item) => { setForm({ ...item }); setShowAddModal(true); };

            return (
                <div className="pb-20 animate-slideUp">
                    <div className="flex bg-white dark:bg-darkCard p-1 rounded-xl shadow-sm mb-4 border border-slate-100 dark:border-slate-700"><button onClick={() => setView('lent')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${view === 'lent' ? 'bg-successBg text-success' : 'text-slate-400'}`}>To Receive</button><button onClick={() => setView('borrowed')} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${view === 'borrowed' ? 'bg-dangerBg text-danger' : 'text-slate-400'}`}>To Pay</button></div>
                    <div className="space-y-3">
                        {filtered.map(item => {
                            const paid = safeNum(item.paid); const total = safeNum(item.amount); const remaining = total - paid;
                            const percent = Math.min(100, (paid / total) * 100);
                            const isDone = remaining <= 0;
                            return (
                                <div key={item.id} className={`bg-white dark:bg-darkCard p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 ${isDone ? 'opacity-60' : ''}`}>
                                    <div className="flex justify-between items-center mb-1">
                                        <h3 className="font-bold text-slate-800 dark:text-white text-base">{item.name}</h3>
                                        <span className="font-bold text-lg text-slate-700 dark:text-slate-300">{total.toLocaleString()} <span className="text-xs text-slate-400">{item.currency}</span></span>
                                    </div>
                                    {item.note && <p className="text-xs text-slate-400 italic mb-3">"{item.note}"</p>}
                                    <div className="w-full h-1.5 bg-slate-100 dark:bg-slate-800 rounded-full mb-3 overflow-hidden"><div className={`h-full rounded-full ${view==='lent'?'bg-success':'bg-danger'}`} style={{width: `${percent}%`}}></div></div>
                                    <div className="flex justify-between items-end">
                                        <div className="flex gap-4 text-xs font-medium">
                                            <div className="flex flex-col"><span className="text-slate-400 text-[9px] uppercase">Paid Back</span><span className="text-slate-600 dark:text-slate-300 font-bold text-sm">{paid.toLocaleString()}</span></div>
                                            <div className="flex flex-col"><span className="text-slate-400 text-[9px] uppercase">Remaining</span><span className={`font-bold text-sm ${remaining > 0 ? (view==='lent'?'text-danger':'text-danger') : 'text-success'}`}>{remaining.toLocaleString()}</span></div>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button onClick={() => openEdit(item)} className="p-2 text-slate-300 hover:text-primary"><Icons.Pencil className="w-4 h-4"/></button>
                                            <button onClick={()=>onDelete(item.id)} className="p-2 text-slate-300 hover:text-danger"><Icons.Trash className="w-4 h-4"/></button>
                                            {!isDone && <button onClick={() => setRepayItem(item)} className="ml-1 px-3 py-1.5 bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-white rounded-lg text-xs font-bold hover:bg-slate-200">+ Pay</button>}
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                    <button onClick={openAdd} className="fixed bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-xl flex items-center justify-center hover:scale-105 z-20"><Icons.Plus /></button>
                    
                    {showAddModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                            <div className="bg-white dark:bg-darkCard w-[90%] max-w-sm p-6 rounded-2xl shadow-2xl animate-slideUp">
                                <h3 className="font-bold mb-4 text-slate-800 dark:text-white">{form.id ? 'Edit Debt' : 'Add Debt'}</h3>
                                <input placeholder="Name" className="w-full p-3 mb-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none" value={form.name} onChange={e=>setForm({...form, name:e.target.value})}/>
                                <div className="flex gap-2 mb-3">
                                    <input placeholder="Total Amount" className="flex-1 p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})}/>
                                    <select className="bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl px-3" value={form.currency} onChange={e=>setForm({...form, currency:e.target.value})}><option value="Ks">Ks</option><option value="$">$</option></select>
                                </div>
                                <textarea placeholder="Note (optional)" rows="2" className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none" value={form.note} onChange={e=>setForm({...form, note:e.target.value})}></textarea>
                                <button onClick={()=>{ if(form.id) onUpdate(form.id, form); else onAdd({...form, type:view, paid:0}); setShowAddModal(false); }} className="w-full bg-primary text-white py-3 rounded-xl font-bold">Save</button>
                                <button onClick={()=>setShowAddModal(false)} className="w-full mt-2 text-slate-400 text-sm">Cancel</button>
                            </div>
                        </div>
                    )}

                    {repayItem && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                            <div className="bg-white dark:bg-darkCard w-[90%] max-w-sm p-6 rounded-2xl shadow-2xl animate-slideUp">
                                <h3 className="font-bold mb-2 text-slate-800 dark:text-white">Add Payment</h3>
                                <p className="text-xs text-slate-500 dark:text-slate-400 mb-4">For: {repayItem.name}</p>
                                <input type="number" autoFocus placeholder="Enter Amount" className="w-full p-4 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl text-lg font-bold border-2 border-primary mb-4 outline-none" value={repayAmount} onChange={e=>setRepayAmount(e.target.value)}/>
                                <button onClick={handleRepayment} className="w-full bg-success text-white py-3 rounded-xl font-bold">Confirm Pay</button>
                                <button onClick={()=>{setRepayItem(null); setRepayAmount('');}} className="w-full mt-2 text-slate-400 text-sm">Cancel</button>
                            </div>
                        </div>
                    )}
                </div>
            )
        }

        // --- ASSETS TAB ---
        function AssetsTab({ data, onAdd, onDelete }) {
            const [isOpen, setIsOpen] = useState(false);
            const [form, setForm] = useState({ name: '', amount: '', currency: '$', category: 'Cash' });
            const categories = ['Cash', 'Investment', 'Property'];

            return (
                <div className="pb-20 animate-slideUp">
                    <div className="flex justify-between items-center mb-4 px-2"><h2 className="text-lg font-bold text-slate-700 dark:text-white">Assets</h2><button onClick={()=>setIsOpen(true)} className="text-primary text-sm font-bold bg-primary/10 px-3 py-1 rounded-lg">+ Add New</button></div>
                    <div className="space-y-4">
                        {categories.map(cat => {
                            const items = (data || []).filter(i => i.category === cat);
                            if (items.length === 0) return null;
                            return (
                                <div key={cat}>
                                    <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">{cat}</h3>
                                    <div className="space-y-2">
                                        {items.map(item => (
                                            <div key={item.id} className="bg-white dark:bg-darkCard p-3 rounded-xl shadow-sm flex justify-between items-center border border-slate-100 dark:border-slate-700">
                                                <div><h4 className="font-bold text-slate-700 dark:text-white">{item.name}</h4><p className="text-[10px] text-slate-400">{new Date(item.date).toLocaleDateString()}</p></div>
                                                <div className="flex items-center gap-3"><span className="font-bold text-primary">{safeNum(item.amount).toLocaleString()} {item.currency}</span><button onClick={() => onDelete(item.id)} className="text-slate-300 hover:text-red-500"><Icons.Trash className="w-4 h-4"/></button></div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                    {isOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                            <div className="bg-white dark:bg-darkCard w-3/4 p-6 rounded-2xl shadow-2xl">
                                <h3 className="font-bold mb-4 text-slate-800 dark:text-white">Add Asset</h3>
                                <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg mb-3">{categories.map(c=><button key={c} onClick={()=>setForm({...form, category:c})} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md ${form.category===c?'bg-white dark:bg-darkCard shadow text-primary':'text-slate-400'}`}>{c}</button>)}</div>
                                <input placeholder="Name" className="w-full p-3 mb-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none" onChange={e=>setForm({...form, name:e.target.value})}/>
                                <div className="flex gap-2 mb-4"><input placeholder="Value" type="number" className="flex-1 p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none" onChange={e=>setForm({...form, amount:e.target.value})}/><select className="bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl px-3" onChange={e=>setForm({...form, currency:e.target.value})}><option value="$">$</option><option value="Ks">Ks</option></select></div>
                                <button onClick={()=>{onAdd({...form}); setIsOpen(false)}} className="w-full bg-primary text-white py-3 rounded-xl font-bold">Save</button>
                                <button onClick={()=>setIsOpen(false)} className="w-full mt-2 text-slate-400 text-sm">Cancel</button>
                            </div>
                        </div>
                    )}
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
