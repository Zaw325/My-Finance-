<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Master V45 (Fixed)</title>
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0f766e', 
                        primaryDark: '#115e59', 
                        bgSoft: '#f8fafc',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        darkCard: '#1e293b',
                        dollar: '#16a34a', 
                        kyat: '#d97706',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        input, button, select, textarea { outline: none; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        input[type="date"] { -webkit-appearance: none; display: block; font-family: inherit; }
    </style>
</head>
<body class="transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const { useState, useEffect, Component } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyuCbPWKCcWYqPCcxW92wE2nZFUu_hC-c",
            authDomain: "mrs-sparkles-qc-app.firebaseapp.com",
            projectId: "mrs-sparkles-qc-app",
            storageBucket: "mrs-sparkles-qc-app.firebasestorage.app",
            messagingSenderId: "692678390922",
            appId: "1:692678390922:web:0e0ada716c87fe02b0a973"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const DATA_KEY = 'finance_master_v32_final_standard'; 
        const SYNC_ID_KEY = 'finance_master_sync_id';

        // --- ICONS ---
        const Icon = ({ d, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>;
        const Icons = {
            PieChart: () => <Icon d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" className="w-5 h-5" />,
            NavCashFlow: () => ( <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><path d="M14 2v6h6" /><path d="M16 13H8" /><path d="M16 17H8" /><path d="M10 9H8" /><circle cx="12" cy="12" r="9" className="opacity-0" /></svg>),
            NavBudget: () => ( <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><path d="M3 21h18" /><path d="M5 21v-7" /><path d="M9 21v-10" /><path d="M13 21v-12" /><path d="M17 21v-5" /><path d="M3 14l18-10" /><path d="M17 4h4v4" /></svg>),
            NavDebt: () => ( <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><circle cx="14" cy="12" r="8" /><path d="M14 8v8" /><path d="M12 10h4" /><path d="M12 14h4" /><path d="M2 10h3" /><path d="M2 14h3" /><path d="M4 12h2" /></svg>),
            NavAsset: () => ( <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><path d="M17 10V7a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v3" /><path d="M5 14h14l-1.5 6.5a2 2 0 0 1-2 1.5h-7a2 2 0 0 1-2-1.5L5 14z" /><path d="M12 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" /><path d="M12 14v-4" /></svg>),
            Plus: () => <Icon d="M12 5v14M5 12h14" className="w-6 h-6" />,
            Trash: () => <Icon d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" className="w-4 h-4" />,
            Pencil: () => <Icon d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" className="w-4 h-4" />,
            Calendar: () => <Icon d="M19 4h-1V3a1 1 0 0 0-2 0v1H8V3a1 1 0 0 0-2 0v1H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2 2V6a2 2 0 0 0-2-2zm0 16H5V9h14v11z" className="w-5 h-5" />,
            Check: () => <Icon d="M20 6L9 17l-5-5" className="w-5 h-5" />,
            X: () => <Icon d="M18 6L6 18M6 6l12 12" className="w-6 h-6" />,
            Left: () => <Icon d="M15 18l-6-6 6-6" className="w-5 h-5" />,
            Right: () => <Icon d="M9 18l6-6-6-6" className="w-5 h-5" />,
            Lock: () => <Icon d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" className="w-5 h-5" />,
            Moon: () => <Icon d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" className="w-5 h-5" />,
            Settings: () => <Icon d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" className="w-5 h-5" />,
            Cloud: () => <Icon d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" className="w-5 h-5" />,
            CloudCheck: () => <Icon d="M20 6L9 17l-5-5" className="w-5 h-5" />,
            Users: () => <Icon d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm14 14v-2a4 4 0 0 0-3-3.87M23 7a4 4 0 1 0-4-4 4 4 0 0 0 4 4z" className="w-5 h-5" />,
            Google: () => <svg className="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35 11.1h-9.17v2.73h6.51c-.33 3.81-3.5 5.44-6.5 5.44C8.36 19.27 5 16.25 5 12c0-4.1 3.2-7.27 7.2-7.27 3.09 0 4.9 1.97 4.9 1.97L19 4.72S16.56 2 12.1 2C6.42 2 2.03 6.8 2.03 12c0 5.05 4.13 10 10.22 10 5.35 0 9.25-3.67 9.25-9.09 0-1.15-.15-1.81-.15-1.81z"/></svg>,
            ArrowUp: () => <Icon d="M12 19V5M5 12l7-7 7 7" className="w-4 h-4" />,
            ArrowDown: () => <Icon d="M12 5v14M5 12l7 7 7-7" className="w-4 h-4" />,
            Download: () => <Icon d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" className="w-5 h-5" />,
            Tag: () => <Icon d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82zM7 7h.01" className="w-5 h-5" />,
            MoreDots: () => <Icon d="M12 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm6 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-12 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" className="w-5 h-5" />,
            Car: () => <Icon d="M5 17h14v-2.3c0-.3.1-.6.3-.9l2-4.1c.4-.8-.2-1.7-1.1-1.7H3.8c-.9 0-1.5.9-1.1 1.7l2 4.1c.2.3.3.6.3.9V17zm2.5-3a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm9 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z" className="w-5 h-5" />,
            Shopping: () => <Icon d="M16 11V7a4 4 0 0 0-8 0v4M5 9h14l1 12H4L5 9z" className="w-5 h-5" />,
            Phone: () => <Icon d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.12 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" className="w-5 h-5" />,
            Zap: () => <Icon d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" className="w-5 h-5" />,
            Train: () => <Icon d="M2 12h20M2 16h20M4 12v6M20 12v6M3 7h18l-1-4H4L3 7z" className="w-5 h-5" />,
            Gift: () => <Icon d="M20 12v10H4V12M2 7h20v5H2zM12 22V7M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7zM12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" className="w-5 h-5" />,
            Smile: () => <Icon d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm0-14a2 2 0 1 0 2 2 2 2 0 0 0-2-2zm0 10a5 5 0 0 1-4-2.5" className="w-5 h-5" />,
            CloudUpload: () => <Icon d="M16 16l-4-4-4 4M12 12v9" className="w-5 h-5" />,
            Save: () => <Icon d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8V3" className="w-5 h-5" />,
            Wallet: () => <Icon d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2z" className="w-5 h-5" />,
            Briefcase: () => <Icon d="M20 7h-4V4c0-1.1-.9-2-2-2h-4C9 2 8 2.9 8 4v3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2z" className="w-5 h-5" />,
            Target: () => <Icon d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm0-14a6 6 0 1 0 6 6 6 6 0 0 0-6-6zm0 10a4 4 0 1 1 4-4 4 4 0 0 1-4 4z" className="w-5 h-5" />,
            Reset: () => <Icon d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" className="w-5 h-5" />,
            Warning: () => <Icon d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4m0 4h.01" className="w-5 h-5" />,
            Filter: () => <Icon d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" className="w-5 h-5" />,
            History: () => <Icon d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" className="w-5 h-5" />,
            TrendUp: () => <Icon d="M23 6l-9.5 9.5-5-5L1 18" className="w-5 h-5" />,
        };

        const safeNum = (val) => { const num = parseFloat(val); return isFinite(num) ? num : 0; };
        const calculateSafe = (val) => { try { return String(val||'').replace(/[^0-9.+\-]/g, '').split('+').reduce((sum, part) => sum + (parseFloat(part)||0), 0); } catch { return 0; } };

        const DEFAULT_CATEGORIES = [
            { id: 'inc1', type: 'income', name: 'Salary', icon: 'Wallet', color: '#10b981' }, 
            { id: 'inc2', type: 'income', name: 'Business', icon: 'Briefcase', color: '#3b82f6' }, 
            { id: 'inc3', type: 'income', name: 'Lottery', icon: 'Target', color: '#ef4444' }, 
            { id: 'inc4', type: 'income', name: 'Sale', icon: 'Tag', color: '#8b5cf6' }, 
            { id: 'exp1', type: 'expense', name: 'Grocery', icon: 'Shopping', color: '#f97316' }, 
            { id: 'exp2', type: 'expense', name: 'Ph bill', icon: 'Phone', color: '#3b82f6' },   
            { id: 'exp3', type: 'expense', name: 'Utility', icon: 'Zap', color: '#eab308' },     
            { id: 'exp4', type: 'expense', name: 'Consumer', icon: 'Smile', color: '#ec4899' },  
            { id: 'exp5', type: 'expense', name: 'MRT card', icon: 'Train', color: '#6366f1' },  
            { id: 'exp6', type: 'expense', name: 'Gift', icon: 'Gift', color: '#ef4444' },       
        ];

        // --- DATA LOADING & MIGRATION ---
        const loadLocalData = () => {
            try {
                const raw = localStorage.getItem(DATA_KEY);
                const defaultData = { cashflow: [], debts: [], assets: [], budgets: [], categories: DEFAULT_CATEGORIES, settings: { budget: 0, darkMode: false, pin: null } };
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (!parsed.categories || !Array.isArray(parsed.categories)) parsed.categories = DEFAULT_CATEGORIES;
                    
                    // --- MIGRATION FOR NEW DEBT HISTORY ---
                    if (parsed.debts && Array.isArray(parsed.debts)) {
                        parsed.debts = parsed.debts.map(d => {
                            if (!d.history) {
                                d.history = [];
                                if (d.paid > 0) {
                                    d.history.push({
                                        date: d.date || new Date().toISOString(),
                                        amount: d.paid,
                                        type: 'payment',
                                        note: 'Initial Balance'
                                    });
                                }
                            }
                            return d;
                        });
                    }
                    return { ...defaultData, ...parsed };
                }
                return defaultData;
            } catch { return { cashflow: [], debts: [], assets: [], budgets: [], categories: DEFAULT_CATEGORIES, settings: { budget: 0, darkMode: false, pin: null } }; }
        };

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() { if (this.state.hasError) return <div className="p-10 text-center"><h1>Something went wrong.</h1><button onClick={()=>window.location.reload()} className="mt-4 p-2 bg-blue-500 text-white rounded">Reload</button></div>; return this.props.children; }
        }

        const triggerConfetti = () => { try { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#10b981', '#f59e0b', '#3b82f6'] }); } catch(e) {} };
        const downloadJSON = (data) => { const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `finance_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
        const downloadCSV = (data) => {
            const headers = ['Type', 'Date', 'Title', 'Category', 'Amount'];
            const rows = (data.cashflow || []).map(i => [ i.type, new Date(i.date).toLocaleDateString(), `"${(i.title||'').replace(/"/g, '""')}"`, `"${i.category || ''}"`, i.amount ]);
            const csvContent = [ headers.join(','), ...rows.map(e => e.join(',')) ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `finance_data_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        const SimpleDonutChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-center text-xs text-slate-400 py-4">No expense data to show chart</div>;
            const total = data.reduce((s, i) => s + i.value, 0);
            let cumPercent = 0;
            const colors = ['#0f766e', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#8b5cf6', '#ec4899'];
            const getCoordinatesForPercent = (percent) => { const x = Math.cos(2 * Math.PI * percent); const y = Math.sin(2 * Math.PI * percent); return [x, y]; };
            return (<div className="flex items-center justify-center gap-4"><div className="relative w-32 h-32"><svg viewBox="-1 -1 2 2" className="transform -rotate-90 w-full h-full">{data.map((slice, i) => { const start = getCoordinatesForPercent(cumPercent); cumPercent += slice.value / total; const end = getCoordinatesForPercent(cumPercent); const largeArcFlag = slice.value / total > 0.5 ? 1 : 0; const pathData = `M 0 0 L ${start[0]} ${start[1]} A 1 1 0 ${largeArcFlag} 1 ${end[0]} ${end[1]} L 0 0`; return <path key={i} d={pathData} fill={colors[i % colors.length]} />; })}<circle cx="0" cy="0" r="0.6" className="fill-white dark:fill-darkCard" /></svg></div><div className="space-y-1">{data.map((slice, i) => (<div key={i} className="flex items-center gap-2 text-[10px] font-bold"><div className="w-3 h-3 rounded-full" style={{backgroundColor: colors[i % colors.length]}}></div><span className="text-slate-600 dark:text-slate-300">{slice.name} ({Math.round((slice.value/total)*100)}%)</span></div>))}</div></div>);
        };

        function App() {
            const [data, setData] = useState(loadLocalData);
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isLocked, setIsLocked] = useState(!!(data.settings && data.settings.pin));
            const [showSettings, setShowSettings] = useState(false);
            const [darkMode, setDarkMode] = useState(data.settings ? data.settings.darkMode : false);
            const [syncStatus, setSyncStatus] = useState('idle');
            const [syncId, setSyncId] = useState(localStorage.getItem(SYNC_ID_KEY) || '');

            useEffect(() => { const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u)); return () => unsubscribe(); }, []);
            useEffect(() => {
                let unsub;
                if (user) {
                    setSyncStatus('syncing');
                    const ref = doc(db, syncId ? "groups" : "users", syncId || user.uid);
                    unsub = onSnapshot(ref, (snap) => {
                        if (snap.exists()) {
                            const cloudData = snap.data();
                            if(!cloudData.categories) cloudData.categories = DEFAULT_CATEGORIES;
                            setData(cloudData);
                            setSyncStatus('success');
                        } else setSyncStatus('idle');
                    }, (err) => { console.error(err); setSyncStatus('error'); });
                } else setSyncStatus('idle');
                return () => { if (unsub) unsub(); };
            }, [user, syncId]);

            useEffect(() => {
                const newData = { ...data, settings: { ...data.settings, darkMode } };
                localStorage.setItem(DATA_KEY, JSON.stringify(newData));
                if (darkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
                if (user) { const t = setTimeout(async () => { try { await setDoc(doc(db, syncId ? "groups" : "users", syncId || user.uid), newData); if(syncStatus!=='error') setSyncStatus('success'); } catch { setSyncStatus('error'); } }, 2000); return () => clearTimeout(t); }
            }, [data, darkMode, user, syncId]);

            const handleLogin = async () => { try { await signInWithPopup(auth, provider); } catch (e) { alert("Login failed."); } };
            const handleLogout = async () => { await signOut(auth); };
            const handleSetSyncId = (id) => { const i = id.trim(); setSyncId(i); localStorage.setItem(SYNC_ID_KEY, i); alert(i ? `Switched to Group: ${i}` : "Personal Mode"); };
            const handleForceSave = async () => { if(!user) return alert("Please login first."); try { await setDoc(doc(db, syncId ? "groups" : "users", syncId || user.uid), { ...data, settings: { ...data.settings, darkMode } }); alert("Saved to Cloud."); } catch (error) { alert("Save Failed"); } };
            const handleImportJSON = (jsonString) => { try { const parsed = JSON.parse(jsonString); if (confirm("Replace data?")) { if(!parsed.categories) parsed.categories = DEFAULT_CATEGORIES; setData(parsed); alert("Restored!"); } } catch (e) { alert("Invalid Data"); } };
            const handleNuke = async () => {
                if(!user) return alert("Login required");
                if(confirm("ðŸ”¥ DELETE EVERYTHING?")) {
                    if(prompt("Type DELETE") !== "DELETE") return;
                    const emptyData = { cashflow: [], debts: [], assets: [], budgets: [], categories: DEFAULT_CATEGORIES, settings: { budget: 0, darkMode, pin: null } };
                    setData(emptyData); localStorage.setItem(DATA_KEY, JSON.stringify(emptyData));
                    try { await setDoc(doc(db, syncId ? "groups" : "users", syncId || user.uid), emptyData); alert("NUKED."); } catch(e) { alert("Cloud wipe failed."); }
                }
            };

            const addEntry = (key, item) => { const finalAmt = calculateSafe(item.amount); const newItem = key === 'debts' ? { ...item, amount: finalAmt, paid: 0, status: 'active', history: [] } : { ...item, amount: finalAmt }; setData(prev => ({ ...prev, [key]: [{ ...newItem, id: Date.now(), date: item.date || new Date().toISOString() }, ...(prev[key]||[])] })); };
            const updateEntry = (key, id, updates) => { setData(prev => ({ ...prev, [key]: prev[key].map(item => { if (item.id !== id) return item; return { ...item, ...updates }; }) })); };
            const deleteEntry = (key, id) => { if(confirm("Delete?")) setData(prev => ({ ...prev, [key]: prev[key].filter(i => i.id !== id) })); };
            const updateSettings = (s) => setData(prev => ({ ...prev, settings: { ...prev.settings, ...s } }));
            const addCategory = (cat) => setData(prev => ({ ...prev, categories: [...(prev.categories||[]), { ...cat, id: Date.now() }] }));
            const deleteCategory = (id) => { if(confirm("Delete?")) setData(prev => ({ ...prev, categories: prev.categories.filter(c => c.id !== id) })); };

            if (isLocked && data.settings?.pin) return <PinScreen correctPin={data.settings.pin} onUnlock={() => setIsLocked(false)} />;

            return (
                <div className="max-w-md mx-auto min-h-screen pb-24 relative bg-bgSoft text-slate-800 dark:bg-gray-900 dark:text-white transition-colors duration-300">
                     <div className="flex justify-between items-center p-5 bg-white dark:bg-darkCard sticky top-0 z-40 shadow-sm"><div className="flex flex-col"><h1 className="text-xl font-black text-primary tracking-tight dark:text-white">Finance Master</h1><div className="flex items-center gap-1">{user ? <span className={`text-[10px] flex items-center gap-1 font-bold ${syncStatus==='success'?'text-success':syncStatus==='error'?'text-danger':'text-orange-500'}`}>{syncStatus==='syncing'?'Syncing...':syncStatus==='error'?'Sync Error':(syncId?`Group: ${syncId}`:'Personal Cloud')}{syncStatus==='success'&&<Icons.CloudCheck />}</span> : <span className="text-[10px] text-slate-400 font-bold">Local Only</span>}</div></div><button onClick={() => setShowSettings(true)} className="p-2 rounded-full bg-gray-100 dark:bg-slate-700"><Icons.Settings /></button></div>
                    
                    <div className="p-4">
                        {activeTab === 'dashboard' && <DashboardTab data={data} user={user} onLogin={handleLogin} syncId={syncId} />}
                        {activeTab === 'cashflow' && <CashflowTab data={data.cashflow} categories={data.categories} budgets={data.budgets} onAdd={(i)=>addEntry('cashflow',i)} onUpdate={(id, d)=>updateEntry('cashflow', id, d)} onDelete={(id)=>deleteEntry('cashflow',id)} onAddCategory={addCategory} onDeleteCategory={deleteCategory} />}
                        {activeTab === 'budget' && <BudgetTab data={data} onAdd={(i)=>addEntry('budgets',i)} onUpdate={(id, d)=>updateEntry('budgets', id, d)} onDelete={(id)=>deleteEntry('budgets',id)} />}
                        {activeTab === 'debts' && <DebtsTab data={data.debts} onAdd={(i)=>addEntry('debts',i)} onUpdate={(id, d)=>updateEntry('debts', id, d)} onDelete={(id)=>deleteEntry('debts',id)} />}
                        {activeTab === 'assets' && <AssetsTab data={data.assets} onAdd={(i)=>addEntry('assets',i)} onUpdate={(id, d)=>updateEntry('assets', id, d)} onDelete={(id)=>deleteEntry('assets',id)} />}
                    </div>

                    <div className="fixed bottom-0 w-full max-w-md bg-white dark:bg-darkCard border-t border-slate-100 dark:border-slate-800 flex justify-around py-3 pb-safe z-30">
                        <NavBtn id="dashboard" icon={<Icons.PieChart />} label="Overview" active={activeTab} set={setActiveTab} />
                        <NavBtn id="cashflow" icon={<Icons.NavCashFlow />} label="CashFlow" active={activeTab} set={setActiveTab} />
                        <NavBtn id="budget" icon={<Icons.NavBudget />} label="Budget" active={activeTab} set={setActiveTab} />
                        <NavBtn id="debts" icon={<Icons.NavDebt />} label="Debts" active={activeTab} set={setActiveTab} />
                        <NavBtn id="assets" icon={<Icons.NavAsset />} label="Assets" active={activeTab} set={setActiveTab} />
                    </div>

                    {showSettings && <SettingsModal user={user} syncId={syncId} data={data} onSetSyncId={handleSetSyncId} onNuke={handleNuke} onForceSave={handleForceSave} onImportJSON={handleImportJSON} onLogin={handleLogin} onLogout={handleLogout} currentPin={data.settings?.pin} darkMode={darkMode} onSave={(s) => { updateSettings(s); setDarkMode(s.darkMode); }} onClose={() => setShowSettings(false)} />}
                </div>
            );
        }

        const NavBtn = ({ id, icon, label, active, set }) => (<button onClick={() => set(id)} className={`flex flex-col items-center gap-1 w-16 transition-colors duration-0 ${active === id ? 'text-primary scale-110' : 'text-slate-400 dark:text-slate-500'}`}><div>{icon}</div><span className="text-[10px] font-bold">{label}</span></button>);
        function PinScreen({ correctPin, onUnlock }) { const [input, setInput] = useState(''); const handleNum = (n) => { const next = input + n; setInput(next); if (next.length === 4) { if (next === correctPin) onUnlock(); else { alert("Wrong PIN"); setInput(''); } } }; return (<div className="h-screen bg-primary dark:bg-darkCard flex flex-col items-center justify-center text-white"><div className="mb-6 p-4 bg-white/10 rounded-full"><Icons.Lock className="w-8 h-8" /></div><h2 className="text-xl font-bold mb-8">Enter PIN</h2><div className="flex gap-4 mb-10">{[0,1,2,3].map(i => (<div key={i} className={`w-4 h-4 rounded-full border-2 border-white/50 ${input.length > i ? 'bg-white' : ''}`}></div>))}</div><div className="grid grid-cols-3 gap-6 w-64">{[1,2,3,4,5,6,7,8,9].map(n => (<button key={n} onClick={() => handleNum(n)} className="w-16 h-16 rounded-full bg-white/10 text-2xl font-bold active:bg-white/30 transition-colors">{n}</button>))}<div className="col-start-2"><button onClick={() => handleNum(0)} className="w-16 h-16 rounded-full bg-white/10 text-2xl font-bold active:bg-white/30 transition-colors">0</button></div></div></div>); }
        function SettingsModal({ user, syncId, data, onSetSyncId, onNuke, onForceSave, onImportJSON, onLogin, onLogout, currentPin, darkMode, onSave, onClose }) { const [isPinEnabled, setIsPinEnabled] = useState(!!currentPin); const [pin, setPin] = useState(currentPin || ''); const [isDark, setIsDark] = useState(darkMode); const [tempSyncId, setTempSyncId] = useState(syncId); const [importData, setImportData] = useState(''); const [showDanger, setShowDanger] = useState(false); const handleSave = () => { if (isPinEnabled && pin.length !== 4) return alert("PIN must be 4 digits"); onSetSyncId(tempSyncId); onSave({ pin: isPinEnabled ? pin : null, darkMode: isDark }); onClose(); }; return (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"><div className="bg-white dark:bg-darkCard w-[90%] max-w-sm p-6 rounded-2xl shadow-2xl animate-slideUp max-h-[90vh] overflow-y-auto hide-scroll"><div className="flex justify-between items-center mb-6 border-b border-slate-100 dark:border-slate-700 pb-3"><h3 className="text-xl font-bold text-slate-800 dark:text-white">Settings</h3><button onClick={onClose} className="p-1 text-slate-400"><Icons.X /></button></div><div className="mb-6"><h4 className="text-xs font-bold text-slate-400 uppercase mb-2">Cloud Sync</h4>{user ? (<div className="space-y-2"><div className="p-2 bg-slate-50 dark:bg-slate-800 rounded-lg text-center text-xs text-slate-600 dark:text-slate-300 truncate">Logged in: <b>{user.email}</b></div><div className="flex gap-2"><button onClick={onForceSave} className="flex-1 py-2 bg-primary text-white rounded-lg text-xs font-bold flex items-center justify-center gap-1 shadow-sm hover:bg-primaryDark"><Icons.CloudCheck className="w-3 h-3" /> Force Save</button><button onClick={onLogout} className="flex-1 py-2 bg-red-100 text-red-600 rounded-lg text-xs font-bold hover:bg-red-200">Sign Out</button></div><input className="w-full p-2 text-xs bg-slate-50 dark:bg-slate-800 border-none rounded-lg text-center" placeholder="Group ID (Optional)" value={tempSyncId} onChange={e => setTempSyncId(e.target.value)} /></div>) : (<button onClick={onLogin} className="w-full py-3 bg-white border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-700 dark:text-white shadow-sm"><Icons.Google /> Sign in to Sync</button>)}</div><div className="mb-6"><h4 className="text-xs font-bold text-slate-400 uppercase mb-2">Backup & Data</h4><div className="grid grid-cols-2 gap-2 mb-2"><button onClick={() => downloadJSON(data)} className="py-3 bg-green-50 dark:bg-green-900/20 text-green-600 dark:text-green-400 rounded-xl text-xs font-bold flex flex-col items-center justify-center gap-1 border border-green-200 dark:border-green-800"><Icons.Save className="w-5 h-5" /> Backup File</button><button onClick={() => downloadCSV(data)} className="py-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-xl text-xs font-bold flex flex-col items-center justify-center gap-1 border border-blue-200 dark:border-blue-800"><Icons.Download className="w-5 h-5" /> Export CSV</button></div><div className="relative"><textarea value={importData} onChange={e => setImportData(e.target.value)} placeholder='Paste backup here to restore...' className="w-full h-10 p-2 pl-3 text-[10px] bg-slate-50 dark:bg-slate-800 rounded-lg border-none resize-none focus:ring-2 ring-primary"></textarea><button onClick={() => onImportJSON(importData)} className="absolute right-1 top-1 bottom-1 px-3 bg-slate-200 dark:bg-slate-700 rounded-md text-[10px] font-bold text-slate-600 dark:text-white">Import</button></div></div><div className="mb-6"><h4 className="text-xs font-bold text-slate-400 uppercase mb-2">Preferences</h4><div className="flex justify-between items-center mb-3 p-2 bg-slate-50 dark:bg-slate-800 rounded-lg"><span className="text-xs font-bold text-slate-700 dark:text-white flex items-center gap-2"><Icons.Moon className="w-4 h-4" /> Dark Mode</span><button onClick={() => setIsDark(!isDark)} className={`w-8 h-4 rounded-full p-0.5 transition-colors ${isDark ? 'bg-primary' : 'bg-slate-300'}`}><div className={`bg-white w-3 h-3 rounded-full shadow-md transform transition-transform ${isDark ? 'translate-x-4' : ''}`}></div></button></div><div className="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-800 rounded-lg"><span className="text-xs font-bold text-slate-700 dark:text-white flex items-center gap-2"><Icons.Lock className="w-4 h-4" /> App Lock</span><button onClick={() => setIsPinEnabled(!isPinEnabled)} className={`w-8 h-4 rounded-full p-0.5 transition-colors ${isPinEnabled ? 'bg-primary' : 'bg-slate-300'}`}><div className={`bg-white w-3 h-3 rounded-full shadow-md transform transition-transform ${isPinEnabled ? 'translate-x-4' : ''}`}></div></button></div>{isPinEnabled && <input type="number" className="mt-2 w-full p-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-center text-lg tracking-widest font-bold" value={pin} onChange={e => setPin(e.target.value.slice(0,4))} placeholder="0000" />}</div><div className="border-t border-slate-100 dark:border-slate-700 pt-4">{!showDanger ? (<button onClick={() => setShowDanger(true)} className="w-full text-xs text-red-400 hover:text-red-500 font-medium flex items-center justify-center gap-1">Advanced / Danger Zone <Icons.Warning /></button>) : (<div className="animate-fadeIn bg-red-50 dark:bg-red-900/20 p-3 rounded-xl border border-red-100 dark:border-red-800 text-center"><p className="text-[10px] text-red-600 mb-2">This will delete ALL data permanently.</p><button onClick={onNuke} className="w-full py-2 bg-red-500 text-white text-xs font-bold rounded-lg">ðŸ”¥ DELETE EVERYTHING</button></div>)}</div><button onClick={handleSave} className="w-full mt-4 py-3 bg-primary text-white rounded-xl font-bold shadow-lg hover:bg-primaryDark transition-colors">Save Changes</button></div></div>); }

        // --- DASHBOARD ---
        function DashboardTab({ data, user, onLogin, syncId }) {
            const cashOnHand = (data.cashflow || []).filter(i=>i.type==='income').reduce((s,i)=>s+safeNum(i.amount),0) - (data.cashflow || []).filter(i=>i.type==='expense').reduce((s,i)=>s+safeNum(i.amount),0);
            const assetsUsd = (data.assets || []).filter(i=>i.currency==='$').reduce((s,i)=>s+safeNum(i.amount),0);
            const debtsUsd = (data.debts || []).filter(d=>d.currency==='$').reduce((s,d)=> s + (d.type==='lent' ? (d.amount-d.paid) : -(d.amount-d.paid)), 0);
            const currentMonthKey = new Date().toISOString().slice(0, 7); 
            const thisMonthItems = (data.cashflow || []).filter(i => i.date && i.date.startsWith(currentMonthKey));
            const incomeMonth = thisMonthItems.filter(i => i.type === 'income').reduce((s, i) => s + safeNum(i.amount), 0);
            const expenseMonth = thisMonthItems.filter(i => i.type === 'expense').reduce((s, i) => s + safeNum(i.amount), 0);
            const monthName = new Date().toLocaleString('default', { month: 'long' });
            const expenseByCategory = thisMonthItems.filter(i => i.type === 'expense').reduce((acc, item) => { const cat = item.category || 'Uncategorized'; acc[cat] = (acc[cat] || 0) + safeNum(item.amount); return acc; }, {});
            const chartData = Object.keys(expenseByCategory).map(key => ({ name: key, value: expenseByCategory[key] }));

            return (
                <div className="space-y-4 animate-slideUp pb-10">
                    <div className="bg-gradient-to-br from-primary to-primaryDark text-white p-6 rounded-[2rem] shadow-2xl shadow-primary/30 relative overflow-hidden">
                        <div className="flex justify-between items-start mb-3"><h2 className="text-primaryLight text-xs font-bold tracking-widest uppercase">Net Worth Breakdown</h2>{syncId && <div className="px-2 py-0.5 bg-white/20 rounded text-[10px] font-bold flex items-center gap-1"><Icons.Users className="w-3 h-3"/> Group: {syncId}</div>}</div>
                        <div className="grid grid-cols-2 gap-4"><div><p className="text-[10px] text-primaryLight uppercase">Total ($)</p><div className="text-3xl font-black tracking-tight">${(cashOnHand + assetsUsd + debtsUsd).toLocaleString()}</div></div><div className="text-right border-l border-white/20 pl-4"><p className="text-[10px] text-primaryLight uppercase">Liquid Cash</p><div className="text-xl font-bold tracking-tight">${cashOnHand.toLocaleString()}</div></div></div>
                        <div className="mt-4 pt-4 border-t border-white/10 grid grid-cols-2 gap-2 text-[9px] text-primaryLight text-center"><div><p className="opacity-70">Assets ($)</p><p className="font-bold text-white">${assetsUsd.toLocaleString()}</p></div><div><p className="opacity-70">Debts ($)</p><p className="font-bold text-white">${debtsUsd.toLocaleString()}</p></div></div>
                    </div>
                    <div className="flex gap-3">
                        <div className="flex-1 bg-white dark:bg-darkCard p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 flex flex-col justify-center"><div className="flex items-center gap-2 mb-1"><div className="p-1.5 bg-green-100 text-green-600 rounded-lg"><Icons.ArrowUp /></div><span className="text-xs font-bold text-slate-400 uppercase">Income</span></div><div className="text-xl font-black text-slate-800 dark:text-white tracking-tight">${incomeMonth.toLocaleString()}</div></div>
                        <div className="flex-1 bg-white dark:bg-darkCard p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 flex flex-col justify-center"><div className="flex items-center gap-2 mb-1"><div className="p-1.5 bg-red-100 text-red-600 rounded-lg"><Icons.ArrowDown /></div><span className="text-xs font-bold text-slate-400 uppercase">Expense</span></div><div className="text-xl font-black text-slate-800 dark:text-white tracking-tight">${expenseMonth.toLocaleString()}</div></div>
                    </div>
                    <div className="bg-white dark:bg-darkCard p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800"><h3 className="text-xs font-bold text-slate-400 uppercase mb-4 text-center">Spending by Category ({monthName})</h3><SimpleDonutChart data={chartData} /></div>
                    {!user && (<div className="bg-orange-50 dark:bg-orange-900/20 border border-orange-100 dark:border-orange-800 p-4 rounded-xl flex items-center justify-between"><div><h4 className="font-bold text-orange-800 dark:text-orange-200 text-sm">Data Not Synced</h4><p className="text-xs text-orange-600 dark:text-orange-300">Login to backup your data.</p></div><button onClick={onLogin} className="bg-orange-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-md">Login</button></div>)}
                </div>
            );
        }

        // --- BUDGET TAB ---
        function BudgetTab({ data, onAdd, onUpdate, onDelete }) {
            const [showModal, setShowModal] = useState(false);
            const [editId, setEditId] = useState(null);
            const [selectedCat, setSelectedCat] = useState('');
            const [limit, setLimit] = useState('');
            const currentMonthKey = new Date().toISOString().slice(0, 7);
            const expenses = (data.cashflow || []).filter(i => i.type === 'expense' && i.date && i.date.startsWith(currentMonthKey));
            const expenseCats = (data.categories || []).filter(c => c.type === 'expense');
            const getCatInfo = (name) => { const found = (data.categories || []).find(c => c.name === name); return found || { icon: 'Target', color: '#cbd5e1' }; };
            const handleSave = () => { if(!selectedCat || !limit) return alert("Please fill all fields"); if(editId) { onUpdate(editId, { name: selectedCat, limit }); } else { onAdd({ name: selectedCat, limit }); } setShowModal(false); setEditId(null); setSelectedCat(''); setLimit(''); };
            const openEdit = (item) => { setEditId(item.id); setSelectedCat(item.name); setLimit(item.limit); setShowModal(true); };

            return (
                <div className="pb-20 animate-slideUp">
                    <div className="flex justify-between items-center mb-4 px-2"><h2 className="text-lg font-bold text-slate-700 dark:text-white">Monthly Budgets</h2></div>
                    <div className="space-y-4">{(data.budgets || []).length === 0 ? <p className="text-center text-slate-400 text-sm py-10">No budgets set. Create one to track spending.</p> : (data.budgets || []).map(b => { const spent = expenses.filter(e => e.category === b.name).reduce((s, e) => s + safeNum(e.amount), 0); const limitVal = safeNum(b.limit); const percent = Math.min((spent / limitVal) * 100, 100); const isOver = spent > limitVal; const isNear = percent > 80; const colorClass = isOver ? 'bg-danger' : (isNear ? 'bg-warning' : 'bg-success'); const { icon, color } = getCatInfo(b.name); const IconComp = Icons[icon] || Icons.Tag; return (<div key={b.id} className="bg-white dark:bg-darkCard p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 relative overflow-hidden group"><div className="flex justify-between items-center mb-3"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full flex items-center justify-center text-white shadow-sm" style={{ backgroundColor: color }}><IconComp className="w-5 h-5" /></div><div><h4 className="font-bold text-slate-800 dark:text-white text-base">{b.name}</h4><p className="text-[10px] text-slate-400">Limit: ${limitVal.toLocaleString()}</p></div></div><div className="flex items-center gap-2"><div className="text-right mr-2"><div className={`font-black text-lg ${isOver ? 'text-danger' : (isNear ? 'text-warning' : 'text-success')}`}>${spent.toLocaleString()}</div>{isOver && <div className="text-[10px] font-bold text-white bg-danger px-1.5 py-0.5 rounded animate-pulse inline-block">OVER!</div>}</div><button onClick={() => openEdit(b)} className="p-1.5 text-slate-300 hover:text-primary"><Icons.Pencil className="w-4 h-4"/></button><button onClick={() => onDelete(b.id)} className="p-1.5 text-slate-300 hover:text-danger"><Icons.Trash className="w-4 h-4"/></button></div></div><div className="w-full h-2 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden"><div className={`h-full rounded-full ${colorClass} progress-bar`} style={{width: `${percent}%`}}></div></div></div>); })}</div>
                    <button onClick={() => { setEditId(null); setSelectedCat(''); setLimit(''); setShowModal(true); }} className="fixed bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-xl flex items-center justify-center hover:scale-105 z-20"><Icons.Plus /></button>
                    {showModal && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"><div className="bg-white dark:bg-darkCard w-[90%] max-w-sm p-6 rounded-2xl shadow-2xl animate-slideUp"><h3 className="font-bold mb-4 text-slate-800 dark:text-white">{editId ? 'Edit Budget' : 'New Budget'}</h3><div className="mb-4"><label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Select Category</label><div className="grid grid-cols-4 gap-2 max-h-40 overflow-y-auto hide-scroll">{expenseCats.map(c => { const IconComp = Icons[c.icon] || Icons.Tag; const isSelected = selectedCat === c.name; return (<button key={c.id} onClick={() => setSelectedCat(c.name)} className={`flex flex-col items-center justify-center p-2 rounded-xl border-2 transition-all ${isSelected ? 'border-primary bg-primary/5' : 'border-transparent hover:bg-slate-50 dark:hover:bg-slate-700'}`}><div className="w-8 h-8 rounded-full flex items-center justify-center text-white mb-1" style={{backgroundColor: c.color}}><IconComp className="w-4 h-4" /></div><span className={`text-[9px] font-bold truncate w-full text-center ${isSelected ? 'text-primary' : 'text-slate-500'}`}>{c.name}</span></button>); })}</div></div><input placeholder="Monthly Limit ($)" type="number" className="w-full p-4 mb-4 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none font-bold" value={limit} onChange={e=>setLimit(e.target.value)}/><button onClick={handleSave} className="w-full bg-primary text-white py-3 rounded-xl font-bold">{editId ? 'Update' : 'Create'}</button><button onClick={()=>setShowModal(false)} className="w-full mt-2 text-slate-400 text-sm">Cancel</button></div></div>)}
                </div>
            );
        }

        // --- CASHFLOW TAB ---
        function CashflowTab({ data, categories, budgets, onAdd, onUpdate, onDelete, onAddCategory, onDeleteCategory }) {
            const [isOpen, setIsOpen] = useState(false);
            const [isCategoryManagerOpen, setIsCategoryManagerOpen] = useState(false);
            const [editItem, setEditItem] = useState(null);
            const [filter, setFilter] = useState('all');
            const [currentMonth, setCurrentMonth] = useState(new Date().toISOString().slice(0, 7));
            const monthData = (data || []).filter(item => { if(!item.date) return false; if(typeof item.date !== 'string') return false; return item.date.startsWith(currentMonth); }); const filtered = monthData.sort((a,b) => new Date(b.date) - new Date(a.date)).filter(i => filter === 'all' || i.type === filter); const grouped = filtered.reduce((groups, item) => { try { const dateObj = new Date(item.date); if (!isNaN(dateObj.getTime())) { const d = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); if (!groups[d]) groups[d] = []; groups[d].push(item); } } catch(e) { console.warn("Skipping bad date item", item); } return groups; }, {}); const changeMonth = (d) => { const date = new Date(currentMonth + '-01'); date.setMonth(date.getMonth() + d); setCurrentMonth(date.toISOString().slice(0, 7)); }; const formatMonth = (ym) => { const [y, m] = ym.split('-'); return new Date(y, m - 1).toLocaleString('default', { month: 'long', year: 'numeric' }); }; const getCategoryIcon = (catName) => { const found = categories.find(c => c.name === catName); if (found && Icons[found.icon]) { const IconComp = Icons[found.icon]; return <IconComp className="w-5 h-5 text-white" />; } return <span className="text-white font-bold text-xs">{catName.charAt(0)}</span>; }; const getCategoryColor = (catName) => { const found = categories.find(c => c.name === catName); return found ? found.color : '#cbd5e1'; };

            return (
                <div className="pb-20 space-y-4 animate-slideUp">
                    <div className="flex justify-between items-center"><div className="flex bg-white dark:bg-darkCard p-2 rounded-xl shadow-sm items-center gap-2"><button onClick={() => changeMonth(-1)}><Icons.Left className="w-4 h-4 text-slate-400 hover:text-primary"/></button><div className="font-bold text-slate-700 dark:text-white text-sm w-24 text-center">{formatMonth(currentMonth)}</div><button onClick={() => changeMonth(1)}><Icons.Right className="w-4 h-4 text-slate-400 hover:text-primary"/></button></div><button onClick={() => setIsCategoryManagerOpen(true)} className="px-3 py-2 bg-primary/10 text-primary rounded-xl text-xs font-bold flex items-center gap-1 hover:bg-primary hover:text-white transition-colors"><Icons.Tag className="w-4 h-4" /> Categories</button></div>
                    <div className="flex bg-gray-200 dark:bg-slate-800 p-1 rounded-xl">{['all', 'income', 'expense'].map(t => (<button key={t} onClick={() => setFilter(t)} className={`flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all ${filter === t ? 'bg-white dark:bg-darkCard shadow text-primary dark:text-white' : 'text-slate-500'}`}>{t}</button>))}</div>
                    {Object.keys(grouped).length === 0 ? <div className="text-center py-20 text-slate-400 text-sm">No records found for {formatMonth(currentMonth)}</div> : 
                        Object.keys(grouped).map(date => (
                            <div key={date}>
                                <h3 className="text-xs font-bold text-slate-400 mb-2 pl-1">{date}</h3>
                                <div className="bg-white dark:bg-darkCard rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                                    {grouped[date].map((item, idx) => (
                                        <div key={item.id} className={`p-4 flex justify-between items-center ${idx !== grouped[date].length-1 ? 'border-b border-slate-50 dark:border-slate-800' : ''}`}>
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-full flex items-center justify-center shadow-sm" style={{ backgroundColor: getCategoryColor(item.category) }}>{getCategoryIcon(item.category)}</div>
                                                <div><h4 className="font-bold text-slate-700 dark:text-slate-200 text-sm">{item.title}</h4>{item.category && <span className="text-[10px] bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded text-slate-500">{item.category}</span>}</div>
                                            </div>
                                            <div className="flex items-center gap-3"><span className={`font-bold text-sm ${item.type==='income'?'text-success':'text-slate-700 dark:text-slate-300'}`}>{item.type==='income'?'+':'-'}${safeNum(item.amount).toLocaleString()}</span><button onClick={() => { setEditItem(item); setIsOpen(true); }} className="p-1 bg-slate-50 dark:bg-slate-700 rounded text-slate-400 hover:text-primary"><Icons.Pencil className="w-3 h-3"/></button><button onClick={() => onDelete(item.id)} className="p-1 bg-slate-50 dark:bg-slate-700 rounded text-slate-400 hover:text-danger"><Icons.Trash className="w-3 h-3"/></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))
                    }
                    <button onClick={() => { setEditItem(null); setIsOpen(true); }} className="fixed bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-xl flex items-center justify-center hover:scale-105 z-20"><Icons.Plus /></button>
                    {isOpen && <TransactionModal initialData={editItem} categories={categories} onClose={() => setIsOpen(false)} onSave={(data) => { if(editItem) onUpdate(editItem.id, data); else onAdd(data); }} />}
                    {isCategoryManagerOpen && <CategoryManager categories={categories} onAdd={onAddCategory} onDelete={onDeleteCategory} onClose={() => setIsCategoryManagerOpen(false)} />}
                </div>
            );
        }

        function CategoryManager({ categories, onAdd, onDelete, onClose }) {
            const [newCatName, setNewCatName] = useState('');
            const [newCatType, setNewCatType] = useState('expense');
            const [showAdd, setShowAdd] = useState(false);
            const incomes = categories.filter(c => c.type === 'income');
            const expenses = categories.filter(c => c.type === 'expense');
            const CategoryRow = ({ item }) => { const IconComp = Icons[item.icon] || Icons.Tag; return (<div className="flex items-center justify-between p-3 border-b border-slate-50 dark:border-slate-800 last:border-0"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full flex items-center justify-center shadow-sm text-white" style={{ backgroundColor: item.color }}><IconComp className="w-5 h-5" /></div><span className="font-bold text-slate-700 dark:text-white text-sm">{item.name}</span></div><button onClick={() => onDelete(item.id)} className="text-slate-300 hover:text-danger"><Icons.MoreDots /></button></div>); };
            return (<div className="fixed inset-0 z-50 bg-white dark:bg-darkCard animate-slideUp overflow-auto"><div className="sticky top-0 bg-white dark:bg-darkCard p-4 flex items-center justify-between border-b border-slate-100 dark:border-slate-800 z-10"><h2 className="text-xl font-bold text-slate-800 dark:text-white">Create Categories</h2><button onClick={onClose} className="p-2 bg-slate-100 dark:bg-slate-700 rounded-full"><Icons.X /></button></div><div className="p-5 pb-24"><h3 className="text-primary font-bold text-sm uppercase mb-3 mt-2">Income categories</h3><div className="bg-white dark:bg-slate-800/50 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">{incomes.map(c => <CategoryRow key={c.id} item={c} />)}<button onClick={() => { setNewCatType('income'); setShowAdd(true); }} className="w-full py-3 text-center text-primary font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-b-2xl">+ Add Income Category</button></div><h3 className="text-primary font-bold text-sm uppercase mb-3 mt-8">Expense categories</h3><div className="bg-white dark:bg-slate-800/50 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">{expenses.map(c => <CategoryRow key={c.id} item={c} />)}<button onClick={() => { setNewCatType('expense'); setShowAdd(true); }} className="w-full py-3 text-center text-primary font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-700 rounded-b-2xl">+ Add Expense Category</button></div></div>{showAdd && (<div className="fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm"><div className="bg-white dark:bg-darkCard w-[85%] p-6 rounded-2xl shadow-2xl animate-slideUp"><h3 className="font-bold mb-4 text-slate-800 dark:text-white">New {newCatType} Category</h3><input autoFocus placeholder="Name (e.g. Freelance)" className="w-full p-3 mb-4 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none font-bold" value={newCatName} onChange={e=>setNewCatName(e.target.value)}/><div className="grid grid-cols-5 gap-2 mb-6">{['#ef4444', '#f97316', '#f59e0b', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#64748b', '#000000'].map(c => (<div key={c} onClick={() => { const icon = newCatType==='income'?'Wallet':'Tag'; onAdd({ name: newCatName, type: newCatType, color: c, icon }); setShowAdd(false); setNewCatName(''); }} className="h-8 w-8 rounded-full cursor-pointer hover:scale-110 transition-transform" style={{backgroundColor: c}}></div>))}</div><button onClick={() => setShowAdd(false)} className="w-full py-3 bg-slate-100 dark:bg-slate-700 text-slate-500 rounded-xl font-bold">Cancel</button></div></div>)}</div>);
        }

        function TransactionModal({ initialData, categories, onClose, onSave }) {
            const initDesc = initialData && initialData.title !== initialData.category ? initialData.title : '';
            const [form, setForm] = useState(initialData ? {...initialData, description: initDesc} : { type: 'expense', amount: '', category: '', description: '', date: new Date().toISOString() });
            const [isMath, setIsMath] = useState(false);
            const availableCats = categories.filter(c => c.type === form.type);
            const handleSave = () => { if (!form.amount || !form.category) return alert("Please enter amount and category"); const finalTitle = form.description.trim() || form.category; onSave({ ...form, title: finalTitle }); onClose(); };
            const dateValue = form.date ? form.date.split('T')[0] : new Date().toISOString().split('T')[0];
            return (<div className="fixed inset-0 z-50 flex items-start justify-center pt-10"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div><div className="bg-white dark:bg-darkCard w-[95%] max-w-md rounded-2xl p-5 shadow-2xl z-10 relative animate-slideUp"><div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-slate-800 dark:text-white">{initialData ? 'Edit Transaction' : 'Add Transaction'}</h3><button onClick={onClose} className="p-1 bg-slate-100 dark:bg-slate-700 rounded-full"><Icons.X /></button></div><div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl mb-4"><button onClick={() => setForm({...form, type:'expense', category: ''})} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${form.type === 'expense' ? 'bg-white dark:bg-darkCard shadow text-slate-800 dark:text-white' : 'text-slate-400'}`}>Expense</button><button onClick={() => setForm({...form, type:'income', category: ''})} className={`flex-1 py-3 rounded-lg text-sm font-bold transition-all ${form.type === 'income' ? 'bg-white dark:bg-darkCard shadow text-success' : 'text-slate-400'}`}>Income</button></div><div className="space-y-4 mb-4"><div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Date</label><input type="date" className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl text-sm font-bold border-none" value={dateValue} onChange={e => setForm({...form, date: new Date(e.target.value).toISOString()})} /></div><div><input type="text" autoFocus placeholder="0" className="w-full p-4 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl text-3xl text-center font-black border-2 border-transparent focus:border-primary outline-none" value={form.amount} onChange={e => { setForm({...form, amount:e.target.value}); setIsMath(e.target.value.includes('+')); }} />{isMath && <p className="text-xs text-primary text-center mt-1 font-medium">Auto-sum: {calculateSafe(form.amount)}</p>}</div><div><label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Category</label><div className="grid grid-cols-4 gap-2">{availableCats.map(c => { const IconComp = Icons[c.icon] || Icons.Tag; const isSelected = form.category === c.name; return (<button key={c.id} onClick={() => setForm({...form, category: c.name})} className={`flex flex-col items-center justify-center p-2 rounded-xl border-2 transition-all ${isSelected ? 'border-primary bg-primary/5' : 'border-transparent hover:bg-slate-50 dark:hover:bg-slate-700'}`}><div className="w-8 h-8 rounded-full flex items-center justify-center text-white mb-1" style={{backgroundColor: c.color}}><IconComp className="w-4 h-4" /></div><span className={`text-[9px] font-bold truncate w-full text-center ${isSelected ? 'text-primary' : 'text-slate-500'}`}>{c.name}</span></button>); })}</div></div><div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Description (Optional)</label><textarea rows="2" placeholder="What is this for?" className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl text-sm font-medium border-none resize-none focus:ring-2 focus:ring-primary/20" value={form.description} onChange={e => setForm({...form, description:e.target.value})}></textarea></div></div><button onClick={handleSave} className="w-full bg-primary text-white py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95">Save Record</button></div></div>);
        }

        // --- ENHANCED DEBTS TAB (V44) ---
        function DebtsTab({ data, onAdd, onUpdate, onDelete }) {
            const [view, setView] = useState('lent');
            const [showAddModal, setShowAddModal] = useState(false);
            const [selectedDebt, setSelectedDebt] = useState(null); // For detail view
            
            const [form, setForm] = useState({ name: '', amount: '', currency: '$', note: '', date: new Date().toISOString(), dueDate: '' });
            
            const filtered = data.filter(i => i.type === view);
            const totalAmount = filtered.reduce((sum, i) => sum + safeNum(i.amount), 0);
            const totalPaid = filtered.reduce((sum, i) => sum + safeNum(i.paid), 0);
            const totalRemaining = totalAmount - totalPaid;

            const handleSaveNew = () => { 
                if(!form.name || !form.amount) return alert("Required"); 
                onAdd({ ...form, type: view, paid: 0, history: [] }); 
                setShowAddModal(false); 
                setForm({ name: '', amount: '', currency: '$', note: '', date: new Date().toISOString(), dueDate: '' });
            };

            return (
                <div className="pb-20 animate-slideUp">
                    {/* Summary Card */}
                    <div className="bg-gradient-to-br from-slate-800 to-slate-900 text-white p-6 rounded-[2rem] shadow-xl mb-6 border border-slate-700">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex bg-slate-700/50 p-1 rounded-lg">
                                <button onClick={() => setView('lent')} className={`px-3 py-1.5 rounded-md text-[10px] font-bold transition ${view==='lent' ? 'bg-white text-slate-900 shadow' : 'text-slate-400'}`}>Get Back</button>
                                <button onClick={() => setView('borrowed')} className={`px-3 py-1.5 rounded-md text-[10px] font-bold transition ${view==='borrowed' ? 'bg-white text-slate-900 shadow' : 'text-slate-400'}`}>Pay Back</button>
                            </div>
                        </div>
                        <p className="text-xs text-slate-400 uppercase tracking-widest mb-1">Total Remaining</p>
                        <div className="text-4xl font-black tracking-tighter mb-4 flex items-baseline gap-2">
                             ${totalRemaining.toLocaleString()}
                        </div>
                        <div className="w-full h-1.5 bg-slate-700 rounded-full overflow-hidden mb-2">
                            <div className="h-full bg-gradient-to-r from-green-400 to-blue-500" style={{width: `${Math.min(100, (totalPaid/totalAmount)*100)}%`}}></div>
                        </div>
                        <div className="flex justify-between text-[10px] font-bold text-slate-400">
                            <span>Paid: ${totalPaid.toLocaleString()}</span>
                            <span>Total: ${totalAmount.toLocaleString()}</span>
                        </div>
                    </div>

                    {/* Debt List */}
                    <div className="space-y-3">
                        {filtered.map(item => {
                            const amount = safeNum(item.amount);
                            const paid = safeNum(item.paid);
                            const remaining = amount - paid;
                            const percent = Math.min(100, Math.round((paid / amount) * 100));
                            const isPaid = remaining <= 0;
                            // Due Date Logic
                            const isOverdue = !isPaid && item.dueDate && new Date() > new Date(item.dueDate);
                            const daysLeft = item.dueDate ? Math.ceil((new Date(item.dueDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;

                            return (
                                <div key={item.id} onClick={() => setSelectedDebt(item)} className={`bg-white dark:bg-darkCard p-4 rounded-2xl shadow-sm border group relative overflow-hidden transition-all active:scale-95 cursor-pointer ${isOverdue ? 'border-red-500 shadow-red-100 dark:shadow-none' : 'border-slate-100 dark:border-slate-800'}`}>
                                    {isOverdue && <div className="absolute top-0 left-0 bg-red-500 text-white text-[8px] font-bold px-2 py-1 rounded-br-xl z-10 animate-pulse">OVERDUE</div>}
                                    {isPaid && <div className="absolute top-0 right-0 bg-success text-white text-[8px] font-bold px-2 py-1 rounded-bl-xl">COMPLETED</div>}
                                    
                                    <div className="flex justify-between items-start mb-3 mt-1">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-sm ${isPaid ? 'bg-success' : (view === 'lent' ? 'bg-primary' : 'bg-rose-500')}`}>
                                                {item.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-slate-800 dark:text-white text-sm">{item.name}</h3>
                                                <div className="flex gap-2 text-[10px] text-slate-400">
                                                     {item.dueDate ? (
                                                         <span className={`${isOverdue ? 'text-red-500 font-bold' : 'text-blue-500'}`}>
                                                             {isOverdue ? `Due: ${new Date(item.dueDate).toLocaleDateString()}` : `Due in ${daysLeft} days`}
                                                         </span>
                                                     ) : <span>No Due Date</span>}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <div className={`text-lg font-black text-slate-700 dark:text-slate-200`}>${remaining.toLocaleString()}</div>
                                            <div className="text-[10px] text-slate-400">of ${amount.toLocaleString()}</div>
                                        </div>
                                    </div>
                                    <div className="w-full h-1.5 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                                        <div className={`h-full rounded-full transition-all duration-500 ${isPaid ? 'bg-success' : (percent > 50 ? 'bg-yellow-400' : 'bg-slate-300')}`} style={{width: `${percent}%`}}></div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    
                    <button onClick={() => setShowAddModal(true)} className="fixed bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-xl flex items-center justify-center hover:scale-105 z-20"><Icons.Plus /></button>

                    {/* DETAIL MODAL (HISTORY & ACTIONS) */}
                    {selectedDebt && (
                        <DebtDetailModal 
                            item={selectedDebt} 
                            onClose={() => setSelectedDebt(null)} 
                            onUpdate={onUpdate}
                            onDelete={onDelete}
                        />
                    )}

                    {/* NEW ITEM MODAL */}
                    {showAddModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
                            <div className="bg-white dark:bg-darkCard w-[90%] max-w-sm p-6 rounded-2xl shadow-2xl animate-slideUp">
                                <h3 className="font-bold mb-4 text-slate-800 dark:text-white text-lg">New Debt Record</h3>
                                <div className="space-y-4">
                                    <input placeholder="Name (e.g. John)" className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl border-none font-bold" value={form.name} onChange={e=>setForm({...form, name:e.target.value})}/>
                                    <div className="flex gap-2">
                                        <span className="p-3 bg-slate-100 dark:bg-slate-700 rounded-xl font-bold text-slate-500">$</span>
                                        <input placeholder="Amount" type="number" className="flex-1 p-3 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl border-none font-bold" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})}/>
                                    </div>
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase mb-1">Due Date (Optional)</label><input type="date" className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl font-bold text-sm" value={form.dueDate} onChange={e=>setForm({...form, dueDate:e.target.value})}/></div>
                                    <textarea placeholder="Note..." rows="2" className="w-full p-3 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-xl border-none text-sm resize-none" value={form.note} onChange={e=>setForm({...form, note:e.target.value})}></textarea>
                                    <button onClick={handleSaveNew} className="w-full py-3 bg-primary text-white rounded-xl font-bold shadow-lg">Save Record</button>
                                </div>
                                <button onClick={() => setShowAddModal(false)} className="w-full mt-3 py-2 text-slate-400 text-xs font-bold">Cancel</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- DEBT DETAIL MODAL (WITH Z-INDEX FIX) ---
        function DebtDetailModal({ item, onClose, onUpdate, onDelete }) {
            const [tab, setTab] = useState('history'); // history | pay | interest
            const [amount, setAmount] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [note, setNote] = useState('');

            const remaining = safeNum(item.amount) - safeNum(item.paid);
            const history = item.history || [];

            const handleTransaction = (type) => {
                const val = parseFloat(amount);
                if (!val || val <= 0) return alert("Enter valid amount");
                
                let updates = {};
                const newLog = {
                    date: new Date(date).toISOString(),
                    amount: val,
                    type: type, // 'payment' or 'interest'
                    note: note
                };
                const newHistory = [newLog, ...history]; // Add to top

                if (type === 'payment') {
                    const newPaid = safeNum(item.paid) + val;
                    updates = { paid: newPaid, history: newHistory };
                    if(newPaid >= safeNum(item.amount)) triggerConfetti();
                } else if (type === 'interest') {
                    const newTotal = safeNum(item.amount) + val;
                    updates = { amount: newTotal, history: newHistory };
                }

                onUpdate(item.id, updates);
                setAmount(''); setNote('');
                // Stay on modal but switch to history to see update
                setTab('history');
            };

            const handleDelete = () => {
                onDelete(item.id);
                onClose();
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm pointer-events-auto" onClick={onClose}></div>
                    <div className="relative z-10 bg-white dark:bg-darkCard w-full sm:w-[90%] sm:max-w-sm h-[85vh] sm:h-auto sm:rounded-2xl rounded-t-3xl shadow-2xl animate-slideUp pointer-events-auto flex flex-col overflow-hidden">
                        
                        {/* Header */}
                        <div className="p-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-start bg-slate-50 dark:bg-slate-800/50">
                            <div>
                                <h2 className="text-xl font-bold text-slate-800 dark:text-white">{item.name}</h2>
                                <p className="text-xs text-slate-500">{item.dueDate ? `Due: ${item.dueDate}` : 'No deadline'}</p>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] uppercase font-bold text-slate-400">Remaining</p>
                                <p className="text-2xl font-black text-primary">${remaining.toLocaleString()}</p>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex p-2 gap-2 bg-white dark:bg-darkCard">
                            <button onClick={()=>setTab('history')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${tab==='history'?'bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-white':'text-slate-400'}`}>History</button>
                            <button onClick={()=>setTab('pay')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${tab==='pay'?'bg-green-100 text-green-700':'text-slate-400'}`}>+ Pay</button>
                            <button onClick={()=>setTab('interest')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${tab==='interest'?'bg-red-100 text-red-700':'text-slate-400'}`}>+ Interest</button>
                        </div>

                        {/* Content Area */}
                        <div className="flex-1 overflow-y-auto p-4 bg-slate-50 dark:bg-darkCard">
                            
                            {tab === 'history' && (
                                <div className="space-y-3">
                                    {history.length === 0 ? <p className="text-center text-xs text-slate-400 mt-10">No history yet.</p> : 
                                    history.map((h, i) => (
                                        <div key={i} className="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700">
                                            <div className="flex items-center gap-3">
                                                <div className={`p-2 rounded-full ${h.type==='payment'?'bg-green-100 text-green-600':'bg-red-100 text-red-600'}`}>
                                                    {h.type==='payment' ? <Icons.Check className="w-4 h-4"/> : <Icons.TrendUp className="w-4 h-4"/>}
                                                </div>
                                                <div>
                                                    <p className="text-xs font-bold text-slate-700 dark:text-slate-200 capitalize">{h.type}</p>
                                                    <p className="text-[10px] text-slate-400">{new Date(h.date).toLocaleDateString()}</p>
                                                </div>
                                            </div>
                                            <div className={`font-bold text-sm ${h.type==='payment'?'text-success':'text-danger'}`}>
                                                {h.type==='payment'?'-':'+'}${safeNum(h.amount).toLocaleString()}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {(tab === 'pay' || tab === 'interest') && (
                                <div className="space-y-4 animate-slideUp">
                                    <div className={`p-4 rounded-xl text-center ${tab==='pay'?'bg-green-50 text-green-700':'bg-red-50 text-red-700'}`}>
                                        <p className="text-xs font-bold uppercase mb-1">{tab === 'pay' ? 'Add Repayment' : 'Add Interest Amount'}</p>
                                        <p className="text-[10px] opacity-70">{tab === 'pay' ? 'This reduces the remaining debt.' : 'This increases the total debt.'}</p>
                                    </div>
                                    <input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full p-3 bg-white dark:bg-slate-800 rounded-xl font-bold text-sm border border-slate-200 dark:border-slate-700"/>
                                    <input type="number" placeholder="Amount ($)" autoFocus value={amount} onChange={e=>setAmount(e.target.value)} className="w-full p-4 text-center text-2xl font-black rounded-xl bg-white dark:bg-slate-800 border-2 border-transparent focus:border-primary outline-none" />
                                    <textarea placeholder="Optional Note" rows="2" value={note} onChange={e=>setNote(e.target.value)} className="w-full p-3 bg-white dark:bg-slate-800 rounded-xl text-sm border border-slate-200 dark:border-slate-700"></textarea>
                                    <button onClick={() => handleTransaction(tab === 'pay' ? 'payment' : 'interest')} className={`w-full py-4 rounded-xl font-bold text-white shadow-lg ${tab==='pay'?'bg-green-600':'bg-red-500'}`}>
                                        Confirm {tab === 'pay' ? 'Payment' : 'Interest'}
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Footer Actions */}
                        <div className="p-4 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-darkCard flex justify-between">
                            <button onClick={handleDelete} className="text-red-500 text-xs font-bold flex items-center gap-1"><Icons.Trash className="w-4 h-4"/> Delete Record</button>
                            <button onClick={onClose} className="text-slate-400 text-xs font-bold">Close</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- ASSETS TAB (V43) ---
        function AssetsTab({ data, onAdd, onUpdate, onDelete }) {
            const [showModal, setShowModal] = useState(false);
            const [editId, setEditId] = useState(null);
            const [form, setForm] = useState({ name: '', amount: '', currency: '$', category: 'Cash' });
            const categories = ['Cash', 'Investment', 'Property'];
            const handleSave = () => { if(!form.name || !form.amount) return alert("Please fill required fields"); if(editId) { onUpdate(editId, form); } else { onAdd(form); } setShowModal(false); setEditId(null); setForm({ name: '', amount: '', currency: '$', category: 'Cash' }); };
            const openEdit = (item) => { setEditId(item.id); setForm({ ...item }); setShowModal(true); };
            return (<div className="pb-20 animate-slideUp"><div className="flex justify-between items-center mb-4 px-2"><h2 className="text-lg font-bold text-slate-700 dark:text-white">Assets</h2></div><div className="space-y-4">{categories.map(cat => { const items = (data || []).filter(i => i.category === cat); if (items.length === 0) return null; return (<div key={cat}><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">{cat}</h3><div className="space-y-2">{items.map(item => (
                    <div key={item.id} className="bg-white dark:bg-darkCard p-3 rounded-xl shadow-sm flex justify-between items-center border border-slate-100 dark:border-slate-700 group"><div><h4 className="font-bold text-slate-700 dark:text-white">{item.name}</h4><p className="text-[10px] text-slate-400">{new Date(item.date).toLocaleDateString()}</p></div><div className="flex items-center gap-3"><span className={`font-bold ${item.currency==='$'?'text-dollar':'text-kyat'}`}>{safeNum(item.amount).toLocaleString()} {item.currency}</span><div className="flex gap-1"><button onClick={() => openEdit(item)} className="p-1.5 text-slate-300 hover:text-primary"><Icons.Pencil className="w-4 h-4"/></button><button onClick={() => onDelete(item.id)} className="p-1.5 text-slate-300 hover:text-red-500"><Icons.Trash className="w-4 h-4"/></button></div></div></div>))}</div></div>)})}</div><button onClick={() => { setEditId(null); setForm({ name: '', amount: '', currency: '$', category: 'Cash' }); setShowModal(true); }} className="fixed bottom-24 right-5 w-14 h-14 bg-primary text-white rounded-full shadow-xl flex items-center justify-center hover:scale-105 z-20"><Icons.Plus /></button>{showModal && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm"><div className="bg-white dark:bg-darkCard w-3/4 p-6 rounded-2xl shadow-2xl animate-slideUp"><h3 className="font-bold mb-4 text-slate-800 dark:text-white">{editId ? 'Edit Asset' : 'Add Asset'}</h3><div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg mb-3">{categories.map(c=><button key={c} onClick={()=>setForm({...form, category:c})} className={`flex-1 py-1.5 text-[10px] font-bold rounded-md ${form.category===c?'bg-white dark:bg-darkCard shadow text-primary':'text-slate-400'}`}>{c}</button>)}</div><input placeholder="Name" className="w-full p-3 mb-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none" value={form.name} onChange={e=>setForm({...form, name:e.target.value})}/><div className="flex gap-2 mb-4"><input placeholder="Value" type="number" className="flex-1 p-3 bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl border-none" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})}/><select className="bg-slate-50 dark:bg-slate-700 dark:text-white rounded-xl px-3" value={form.currency} onChange={e=>setForm({...form, currency:e.target.value})}><option value="$">$</option><option value="Ks">Ks</option></select></div><button onClick={handleSave} className="w-full bg-primary text-white py-3 rounded-xl font-bold">{editId ? 'Update' : 'Save'}</button><button onClick={()=>setShowModal(false)} className="w-full mt-2 text-slate-400 text-sm">Cancel</button></div></div>)}</div>);
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
